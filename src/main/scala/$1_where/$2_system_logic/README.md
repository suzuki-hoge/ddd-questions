# システムロジックの場合
## お題
+ 何らかの有料会員サイトの状態を参照する
  + 確認中
    + 申込日時がある
    + 申込後に送付するメールの確認日時がない
  + 契約中
    + 申込日時がある
    + メール確認日時がある
  + 停止中
    + 契約中を満たす
    + 未納金がある
  + 解約済み
    + 契約中を満たす
    + 解約日時を持つ
    + 未納金がない
+ 上記を実装後にテーブル仕様変更があったとして、解約済みの場合は削除フラグが立っていることも確認することを想定する

## 案
### sql に書く
見るべきカラムと必要な計算を`sql`で行い、その判定結果を`domain/`にする

![2-1.png](https://qiita-image-store.s3.amazonaws.com/0/113398/e36d6abc-32fd-c328-9770-6ab911522cbf.png)

+ :+1: 処理がほぼ一箇所にまとまっている
+ :-1: `domain/`に`table/`との約束事が書いてある
  + `1`が`Confirming`に相当するという決まり事は業務ロジックではない
+ :-1: パターンテストをしようとすると、データベースにダミーデータの投入が必要になる
+ :-1: テーブル仕様変更の時に`domain/`の修正も必要になる

sql だけで済むし楽かも知れないけど、変換の部分のテストのしづらさがとても残念

### domain に書く
`sql`は必要カラムをかき集めるところまで行い、`domain/`がパラメータを受けて計算する

![2-2.png](https://qiita-image-store.s3.amazonaws.com/0/113398/e975cbee-5b4d-63a5-610b-a26f63842fff.png)

+ :+1: 変換処理のテストが書きやすい
+ :-1: カラム構成や`null / not null`は業務ロジックではない
+ :-1: `domain/`の引数がドメインクラスではない
  + （String, LocalDate 等をプリミティブと言うのも違うので...）
+ :-1: ドメイン層まで`null`が来ている上に、その可能性に気付き辛い
+ :-1: テーブル仕様変更の時に`domain/`の修正も必要になる

`domain/`にプリミティブ等が出てきてしまっている上に`null`検査までしなくてはいけないので、ドメインの安全さが下がってるしシステム色が強すぎるのがとても残念

### repository の実装部に書く
`domain/`の`Status`と`mapper/`の`Status`を分け、sql がかき集めたパラメータは`mapper/`で判定を済ます

![2-3.png](https://qiita-image-store.s3.amazonaws.com/0/113398/e8193725-6687-c0e2-f9e1-e79b1ea8b56d.png)

+ :+1: `domain/`に必要ないクラスが`mapper/`に留まっている
+ :+1: `domain/`に判定ロジックがない
+ :+1: 判定処理のテストが書きやすいし、データベースへのダミーデータの投入も不要
+ :+1: テーブル仕様変更の時に`domain/`の修正が必要ない
+ :-1: 一番手間がかかる
+ :-1: サービス仕様変更で`mapper/`に留めているクラスを`domain/`で使いたくなった場合等の改修が面倒

他と違い`domain/`にノイズが一切無いしテストも容易だけど、他より大変

### 引数に書く
すぐ上の`repository の実装部に書く`の案で判定ロジックを独立させる部分は書いたし、その独立させる部分を`domain/`に手間かけて持ってくるメリットはないと判断し、省略する

## 感想
極端な話、ステータス１カラムでもフラグ10個でもちゃんと計算が終わった値が来れば良くて、ドメインには関係ない
ドメインに現れる必要はない