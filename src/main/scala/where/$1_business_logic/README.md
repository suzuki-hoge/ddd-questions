# 検索条件をどこに書くか
## 業務ロジックの場合
### お題
+ 有効な特典がある顧客を検索して、通知を出す
  + 契約から２年経っていること
  + 契約プランが無料プランであること
+ 上記を実装後に仕様変更があったとして、「ただし先月申し込んだ無料プランの顧客は特別に対象とする」と言う変更を検討する

- - -

+ `Customer`: 汎用的な「顧客クラス」
  + 特定のユースケースを意識しない
+ `CampaignTargetCustomer`: 「特典対象顧客」
  + 特典の通知のためだけに使う

### sql に書く
特典対象顧客を参照して、特典対象顧客に通知をする設計

![1.png](https://qiita-image-store.s3.amazonaws.com/0/113398/18d8768c-f9e2-db59-5566-ad306d82b79c.png)

+ :+1: 特典対象顧客を得ている
+ :+1: 通知する処理が型的に特典対象顧客にしか実施できない
+ :+1: 対象テーブルと検索条件が一箇所にまとまっている
+ :-1: 図の`domain/`はおろか`table/`まで見ても、特典対象者とは何か、が不明である
+ :-1: 仕様変更時の修正が`domain/`ではない
+ :-1: `domain/`で対象判定の単体テストが出来ない
  + `table/`まで結合したらテストが出来るが、データベースへのダミーデータの投入が必要

一番楽だけど、この図を見せられても情報量が少ないし、テストが出来ないのが辛すぎる

### domain に書く
（汎用的な）顧客を参照して、特典対象顧客の場合だけ（汎用的な）顧客に通知をする設計

![2.png](https://qiita-image-store.s3.amazonaws.com/0/113398/f6f99e57-afe5-f895-3b97-4573bd163386.png)

+ :+1: `domain/`に特典対象か判定するロジックがある
+ :+1: 仕様変更は`domain/`の修正で対処する
+ :+1: `domain/`で対象判定の単体テストが出来る
+ :-1: 参照結果が汎用顧客で通知も汎用顧客なため、特典対象顧客でなくても通知する処理がコンパイルできる
  + 呼び元で特典対象か判定して条件分岐するのを忘れてはいけなくなる
  + 強制変換にしろ`Optional`を使うにしろ、どこかに状態不一致の実行時例外が発生する可能性がある
+ :-1: 対象テーブルと検索条件が散る
+ :-1: 今後の案件の実装が全て（汎用的な）顧客に集まり、超巨大な神クラスになってしまう

ロジックをドメインに持って来てみて、単体テストが出来る様になった、けどコンパイルの恩恵が受けられなくなってる残念さが大きい

### repository の実装部に書く
`sql`ではなくて`repository`の実装クラスで判定と変換をする

![3.png](https://qiita-image-store.s3.amazonaws.com/0/113398/99d2b529-563c-31ac-5d98-13475dcf9f60.png)

+ :+1: 型的に安全である
+ :+1: 図には特典対象か判定するロジックがある
+ :-1: やはり`domain/`に検索条件がなく、仕様変更も`mapper/`の修正になる
+ :-1: `mapper/`の（汎用的な）顧客に今後のロジックが全て集まる

前二例の良い所と悪いところが両方合わさった感じ

### 引数に書く
検索方法を`domain/`で指定する

![4.png](https://qiita-image-store.s3.amazonaws.com/0/113398/ded18111-8219-4a85-6183-f9277534da26.png)

+ :+1: `domain/`に対象判定のロジックがあり、メソッド名や関連クラスも明白である
+ :+1: 判定ロジックの単体テストが可能である
+ :-1: 判定ロジックを通し忘れても`mapper/`の（汎用的な）顧客クラスが特典対象顧客に変換出来てしまう
+ :-1: 一番手間がかかる
